{% extends "base.html" %}
{% load i18n %}

{% block title %}
  {% if object %}{% trans "Edit Custody" %}{% else %}{% trans "New Custody" %}{% endif %}
{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="card shadow-sm">
    <div class="card-header {% if object %}bg-warning{% else %}bg-success{% endif %}">
      {% if object %}
        <i class="bi bi-pencil-square"></i> {% trans "Edit Custody" %}
      {% else %}
        <i class="bi bi-plus-circle"></i> {% trans "New Custody" %}
      {% endif %}
    </div>

    <form method="post" autocomplete="off" novalidate>
      <div class="card-body">
        {% csrf_token %}

        <!-- Custody fields -->
        <div class="row g-3">
          {% for field in form %}
            <div class="col-md-{% if not forloop.last %}4{% else %}12{% endif %}">
              <label class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors|striptags }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <hr class="my-2">

        <!-- Devices -->
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="fw-bold mb-3 fs-2">{% trans "Devices" %}</h6>
          <button type="button" class="btn btn-outline-primary my-2" id="add-device">
            <i class="bi bi-plus-circle"></i> {% trans "Add Device" %}
          </button>
        </div>

        {{ devicecustody_formset.management_form }}
        <div class="row p-2" id="devices-container">
          {% for subform in devicecustody_formset %}
            <div class="col-md-4 p-1">
              <div class="device-item border p-2 mb-2 rounded">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label">{{ subform.device.label }}</label>

                  <div class="d-flex">
                    {% if not subform.instance.pk %}
                      <button type="button" class="btn btn-sm btn-outline-danger remove-device p-1 mx-2">
                        <i class="bi bi-trash"></i>
                      </button>
                    {% else %}
                      <!-- زر حذف من قاعدة البيانات -->
                      <a href="{% url 'devicecustody_delete' subform.instance.pk %}?next={{ request.path }}" 
                        class="btn btn-sm btn-outline-danger p-1 mx-2">
                        <i class="bi bi-trash-fill"></i> Delete
                      </a>
                    {% endif %}
                  </div>
                </div>

                {{ subform.device }}
                {% if subform.device.errors %}
                  <div class="text-danger small">{{ subform.device.errors|striptags }}</div>
                {% endif %}

                <label class="form-label">{{ subform.accessories.label }}</label>
                <div class="checkbox-list">
                  {% for checkbox in subform.accessories %}
                  <label class="form-check-label d-block">
                    {{ checkbox.tag }} {{ checkbox.choice_label }}
                  </label>
                  {% endfor %}
                </div>
                {% if subform.accessories.errors %}
                  <div class="text-danger small">{{ subform.accessories.errors|striptags }}</div>
                {% endif %}

                {{ subform.id }}
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Hidden empty form template -->
        <div id="empty-form" style="display:none;">
          <div class="device-item border p-2 mb-2 rounded">
            <div class="d-flex justify-content-between align-items-center">
              <label class="form-label">{{ devicecustody_formset.empty_form.device.label }}</label>
              <button type="button" class="btn btn-sm btn-outline-danger remove-device p-1 mx-2">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            {{ devicecustody_formset.empty_form.device }}
            <label class="form-label">{{ devicecustody_formset.empty_form.accessories.label }}</label>
            <div class="checkbox-list">
              {% for checkbox in devicecustody_formset.empty_form.accessories %}
              <label class="form-check-label d-block">
                {{ checkbox.tag }} {{ checkbox.choice_label }}
              </label>
              {% endfor %}
            </div>
            {{ devicecustody_formset.empty_form.id }}
          </div>
        </div>

      </div>

      <!-- Footer buttons -->
      <div class="card-footer d-flex justify-content-end mt-3">
        <button type="submit" class="btn {% if object %}btn-custom-warning{% else %}btn-custom-primary{% endif %} mx-2">
          {% if object %}
            <i class="bi bi-save"></i> {% trans "Update" %}
          {% else %}
            <i class="bi bi-plus-circle"></i> {% trans "Create" %}
          {% endif %}
        </button>
        <a href="{% url 'custody_list' %}" class="btn btn-secondary">
          <i class="bi bi-x-circle"></i> {% trans "Cancel" %}
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const container = document.getElementById("devices-container");
  const addBtn = document.getElementById("add-device");
  const totalForms = document.querySelector("[name='{{ devicecustody_formset.prefix }}-TOTAL_FORMS']");
  const emptyFormDiv = document.getElementById("empty-form");
  if (!container || !addBtn || !totalForms || !emptyFormDiv) return;

  // Fetch accessories via API
  async function loadAccessories(deviceId, wrapper, selected = []) {
    const accessoriesContainer = wrapper.querySelector(".checkbox-list");
    accessoriesContainer.innerHTML = "";
    if (!deviceId) return;

    const response = await fetch("{% url 'api_device_accessories' %}?device_id=" + deviceId);
    if (!response.ok) return;

    const data = await response.json();
    data.accessories.forEach(acc => {
      const label = document.createElement("label");
      label.classList.add("form-check-label", "d-block");

      const input = document.createElement("input");
      input.type = "checkbox";
      const prefix = wrapper.querySelector("select").name.split('-device')[0];
      input.name = prefix + '-accessories';
      input.value = acc.id;
      input.classList.add("form-check-input", "me-1");
      if (selected.includes(acc.id.toString())) input.checked = true;

      label.appendChild(input);
      label.appendChild(document.createTextNode(acc.name));
      accessoriesContainer.appendChild(label);
    });
  }

  function setupDeviceWrapper(wrapper) {
    const deviceField = wrapper.querySelector("select[id$='-device']");
    if (!deviceField) return;

    const selectedInputs = wrapper.querySelectorAll(".checkbox-list input:checked");
    const selectedValues = Array.from(selectedInputs).map(i => i.value);

    if (deviceField.value) loadAccessories(deviceField.value, wrapper, selectedValues);

    deviceField.addEventListener("change", function () {
      loadAccessories(this.value, wrapper, []);
    });
  }

  container.querySelectorAll(".device-item").forEach(setupDeviceWrapper);

  addBtn.addEventListener("click", function () {
    const formIndex = parseInt(totalForms.value, 10);
    const newFormHtml = emptyFormDiv.innerHTML.replace(/__prefix__/g, formIndex);
    const wrapperCol = document.createElement("div");
    wrapperCol.classList.add("col-md-4", "p-1");
    wrapperCol.innerHTML = newFormHtml;
    container.appendChild(wrapperCol);
    totalForms.value = formIndex + 1;
    setupDeviceWrapper(wrapperCol.querySelector(".device-item"));
  });

  container.addEventListener("click", function (e) {
    if (e.target.closest(".remove-device")) {
      const item = e.target.closest(".device-item");
      const deleteField = item.querySelector("input[type='checkbox'][name$='-DELETE']");
      if (deleteField) {
        deleteField.checked = true;
        item.style.display = "none";
      } else {
        item.remove();
        totalForms.value = parseInt(totalForms.value, 10) - 1;
      }
    }
  });
});
</script>
{% endblock %}
