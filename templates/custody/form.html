{% extends "base.html" %}
{% load static i18n %}

{% block title %}
  {% if object %}{% trans "Edit Custody" %}{% else %}{% trans "New Custody" %}{% endif %}
{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="card shadow-sm">
    <div class="card-header {% if object %}bg-warning{% else %}bg-success{% endif %}">
      {% if object %}
        <i class="bi bi-pencil-square"></i> {% trans "Edit Custody" %}
      {% else %}
        <i class="bi bi-plus-circle"></i> {% trans "New Custody" %}
      {% endif %}
    </div>

    <form method="post" autocomplete="off" novalidate>
      <div class="card-body">
        {% csrf_token %}

        <!-- Custody fields -->
        <div class="row g-3">
          {% for field in form %}
            <div class="col-md-{% if not forloop.last %}4{% else %}12{% endif %}">
              <label class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors|striptags }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <hr class="my-2">

        <!-- Devices -->
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="fw-bold mb-3 fs-2">{% trans "Devices" %}</h6>
          <button type="button" class="btn btn-outline-primary my-2" id="add-device">
            <i class="bi bi-plus-circle"></i> {% trans "Add Device" %}
          </button>
        </div>

        {{ devicecustody_formset.management_form }}
        <div class="row p-2" id="devices-container" 
          data-prefix="{{ devicecustody_formset.prefix }}" 
          data-api-url="{% url 'api_device_accessories' %}">
          {% for subform in devicecustody_formset %}
            <div class="col-md-4 p-1">
              <div class="device-item border p-2 mb-2 rounded">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label">{{ subform.device.label }}</label>

                  <div class="d-flex">
                    {% if not subform.instance.pk %}
                      <button type="button" class="btn btn-sm btn-outline-danger remove-device p-1 mx-2">
                        <i class="bi bi-trash"></i>
                      </button>
                    {% else %}
                      <!-- زر حذف من قاعدة البيانات -->
                      <a href="{% url 'devicecustody_delete' subform.instance.pk %}?next={{ request.path }}" 
                        class="btn btn-sm btn-outline-danger p-1 mx-2">
                        <i class="bi bi-trash-fill"></i> Delete
                      </a>
                    {% endif %}
                  </div>
                </div>

                {{ subform.device }}
                {% if subform.device.errors %}
                  <div class="text-danger small">{{ subform.device.errors|striptags }}</div>
                {% endif %}

                <label class="form-label">{{ subform.accessories.label }}</label>
                <div class="checkbox-list">
                  {% for checkbox in subform.accessories %}
                  <label class="form-check-label d-block">
                    {{ checkbox.tag }} {{ checkbox.choice_label }}
                  </label>
                  {% endfor %}
                </div>
                {% if subform.accessories.errors %}
                  <div class="text-danger small">{{ subform.accessories.errors|striptags }}</div>
                {% endif %}

                {{ subform.id }}
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Hidden empty form template -->
        <div id="empty-form" class="d-none">
          <div class="device-item border p-2 mb-2 rounded">
            <div class="d-flex justify-content-between align-items-center">
              <label class="form-label">{{ devicecustody_formset.empty_form.device.label }}</label>
              <button type="button" class="btn btn-sm btn-outline-danger remove-device p-1 mx-2">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            {{ devicecustody_formset.empty_form.device }}
            <label class="form-label">{{ devicecustody_formset.empty_form.accessories.label }}</label>
            <div class="checkbox-list">
              {% for checkbox in devicecustody_formset.empty_form.accessories %}
              <label class="form-check-label d-block">
                {{ checkbox.tag }} {{ checkbox.choice_label }}
              </label>
              {% endfor %}
            </div>
            {{ devicecustody_formset.empty_form.id }}
          </div>
        </div>

      </div>

      <!-- Footer buttons -->
      <div class="card-footer d-flex justify-content-end mt-3">
        <button type="submit" class="btn {% if object %}btn-custom-warning{% else %}btn-custom-primary{% endif %} mx-2">
          {% if object %}
            <i class="bi bi-save"></i> {% trans "Update" %}
          {% else %}
            <i class="bi bi-plus-circle"></i> {% trans "Create" %}
          {% endif %}
        </button>
        <a href="{% url 'custody_list' %}" class="btn btn-secondary">
          <i class="bi bi-x-circle"></i> {% trans "Cancel" %}
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/custody_form.js' %}"></script>

{% endblock %}
